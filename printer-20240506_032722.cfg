[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include EBB.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]

[temperature_sensor Pi]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

[idle_timeout]
# only turn off heaters and motors if the printer is not paused
gcode:
    {% if not printer.pause_resume.is_paused %}
        TURN_OFF_HEATERS
        M84
    {% endif %}

[autotune_tmc stepper_x]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_y]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z1]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z2]
motor: omc-17he19-2004s
tuning_goal: auto

[input_shaper]
shaper_freq_x: 57.2   #Max 9700mm
shaper_freq_y: 56.6   #Max 9400mm
shaper_type: mzv


[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_0E001F000C50415833323420-if00
canbus_uuid: df8f643798ab
#restart_method: command

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 1000
max_z_velocity: 5
max_z_accel: 100

[cartographer]
#   Path to the serial port for the Cartographer device. Typically has the form
#   /dev/serial/by-id/usb-cartographer_cartographer_...
#   
#   If you are using the CAN Bus version, replace serial: with canbus_uuid: and add the UUID.
canbus_uuid: 410c1e562634
#
speed: 40.
#   Z probing dive speed.
lift_speed: 5.
#   Z probing lift speed.
backlash_comp: 0.00945
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
x_offset: 0.
#   X offset of cartographer from the nozzle.
y_offset: 21.1
#   Y offset of cartographer from the nozzle.
trigger_distance: 2.
#   cartographer trigger distance for homing.
trigger_dive_threshold: 1.5
#   Threshold for range vs dive mode probing. Beyond `trigger_distance +
#   trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006
#   Hysteresis on trigger threshold for untriggering, as a percentage of the
#   trigger threshold.
cal_nozzle_z: 0.1
#   Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1
#   Minimum z bound on sensor response measurement.
cal_ceil:5.
#   Maximum z bound on sensor response measurement.
cal_speed: 1.0
#   Speed while measuring response curve.
cal_move_speed: 10.
#   Speed while moving to position for response curve measurement.
default_model_name: default
#   Name of default cartographer model to load.
mesh_main_direction: x
#   Primary travel direction during mesh measurement.
#mesh_overscan: -1
#   Distance to use for direction changes at mesh line ends. Omit this setting
#   and a default will be calculated from line spacing and available travel.
mesh_cluster_size: 1
#   Radius of mesh grid point clusters.
mesh_runs: 2
#   Number of passes to make during mesh scan.

[lis2dw]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
probe_points:
    127.5,122, 20



[stepper_x]
step_pin: PE6
dir_pin: PA14
enable_pin: !PE0
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan: PB6
position_endstop: 255
position_max: 255
homing_speed: 100

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PD3
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG11
driver_SGTHRS: 70

[stepper_y]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG6
position_endstop: 244
position_max: 244
homing_speed: 100

[tmc2209 stepper_y]
uart_pin: PE1
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG12
driver_SGTHRS: 72

[stepper_z]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8  
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 220
position_min: -5
homing_speed: 10 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC4
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Center
[stepper_z1]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PD11
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Front Right
[stepper_z2]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PC6
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[safe_z_home]
speed: 100
z_hop: 10
z_hop_speed: 5
home_xy_position: 127.5,122

[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBBCan: PA3
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: 0
max_temp: 250

[tmc2209 extruder]
uart_pin: EBBCan: PA15
run_current: 0.650
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF4
#max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid

[bed_mesh]
speed: 300
horizontal_move_z: 10
mesh_min: 35, 35
mesh_max: 200, 220
probe_count: 21,21
algorithm: bicubic


[fan]
pin: EBBCan: PA1

[heater_fan hotend_fan]
pin: EBBCan: PA0
heater: extruder
heater_temp: 50.0

[z_tilt]
z_positions: 8, 8 #stepper_z Mini Tank
  132.5, 247 #stepper_z1 Mini Tank
  257, 8 #stepper_z2 Mini Tank
points: 
  15, 0 #probe location stepper_z (left)
  132.5,210  #probe location stepper_z (rear)
# 15, 210
#  240, 210  
  240, 0 #probe location stepper_z (right)
speed: 400
horizontal_move_z: 10
retries: 5 # Number of times to retry if the probed points aren't within tolerance.
retry_tolerance:0.003







#The following Macro is used to replace the ending gcode in your slicer
#replace the end gcode in your slicer with END_PRINT

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# pid_kp = 42.375
#*# pid_ki = 1.922
#*# pid_kd = 233.590
#*# control = pid
#*#
#*# [extruder]
#*#
#*# [cartographer model default]
#*# model_coef = 1.3603677619316925,
#*# 	1.7351196226592445,
#*# 	0.7905886475253496,
#*# 	0.32609380640133473,
#*# 	0.22748171677272946,
#*# 	0.5225177996593849,
#*# 	0.12942732810068813,
#*# 	-0.6567748632704603,
#*# 	0.04184012423365669,
#*# 	0.5251931019743251
#*# model_domain = 3.1851211326899135e-07,3.3905519664678e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.195134
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.013743, 0.017861, 0.027294, 0.038802, 0.050444, 0.059062, 0.068971, 0.074741, 0.081560, 0.090825, 0.095446, 0.101751, 0.107606, 0.113256, 0.117573, 0.128576, 0.134802, 0.140288, 0.145397, 0.150176, 0.155409
#*# 	  0.007214, 0.015789, 0.024337, 0.034945, 0.046470, 0.057188, 0.066925, 0.076146, 0.082753, 0.087779, 0.091750, 0.099873, 0.108020, 0.113732, 0.118511, 0.123476, 0.128938, 0.137050, 0.145366, 0.150731, 0.152109
#*# 	  -0.000388, 0.008877, 0.017646, 0.029067, 0.041028, 0.052396, 0.063627, 0.073002, 0.082206, 0.085911, 0.090914, 0.097555, 0.103918, 0.107967, 0.114721, 0.120274, 0.125388, 0.132453, 0.140760, 0.147871, 0.151263
#*# 	  -0.009475, -0.000060, 0.008464, 0.021061, 0.033361, 0.044844, 0.057752, 0.069735, 0.077345, 0.081938, 0.088452, 0.094944, 0.100647, 0.104781, 0.109505, 0.116187, 0.121394, 0.128896, 0.137724, 0.143827, 0.148804
#*# 	  -0.026416, -0.015799, -0.004208, 0.009219, 0.021756, 0.034546, 0.047125, 0.059255, 0.068898, 0.073975, 0.080252, 0.087746, 0.093327, 0.098349, 0.103814, 0.109468, 0.115654, 0.123026, 0.132495, 0.138181, 0.142645
#*# 	  -0.040326, -0.028945, -0.016691, -0.001115, 0.012919, 0.025173, 0.037190, 0.048926, 0.058373, 0.064355, 0.071271, 0.079028, 0.086013, 0.091175, 0.096185, 0.102729, 0.108585, 0.116554, 0.125751, 0.131740, 0.137469
#*# 	  -0.057268, -0.043780, -0.030282, -0.015561, -0.000248, 0.013771, 0.025177, 0.035808, 0.047225, 0.053590, 0.062297, 0.069358, 0.076858, 0.084409, 0.089845, 0.095994, 0.102591, 0.111345, 0.122179, 0.129083, 0.131510
#*# 	  -0.069394, -0.054315, -0.043234, -0.027828, -0.013567, -0.000121, 0.011366, 0.023397, 0.033148, 0.041946, 0.051485, 0.060213, 0.067472, 0.073332, 0.079255, 0.087511, 0.095142, 0.105106, 0.113586, 0.121210, 0.125829
#*# 	  -0.087217, -0.071642, -0.055489, -0.040297, -0.026563, -0.014227, -0.001535, 0.010188, 0.020749, 0.029017, 0.039307, 0.048944, 0.056632, 0.062442, 0.067775, 0.076520, 0.085728, 0.097140, 0.106974, 0.114806, 0.120252
#*# 	  -0.103236, -0.085671, -0.070731, -0.053540, -0.039613, -0.028581, -0.016721, -0.003031, 0.007483, 0.016612, 0.026717, 0.036089, 0.044418, 0.049808, 0.055536, 0.065798, 0.075891, 0.088062, 0.098995, 0.106070, 0.110396
#*# 	  -0.119286, -0.103369, -0.085018, -0.066829, -0.052926, -0.040948, -0.029466, -0.016543, -0.003869, 0.005273, 0.016275, 0.026075, 0.034538, 0.040868, 0.047133, 0.056607, 0.067644, 0.081213, 0.093866, 0.100868, 0.106209
#*# 	  -0.134319, -0.116810, -0.099783, -0.080290, -0.064998, -0.054128, -0.042148, -0.028353, -0.016658, -0.005901, 0.004712, 0.014814, 0.023367, 0.030629, 0.038286, 0.049352, 0.060284, 0.074267, 0.086275, 0.095140, 0.102198
#*# 	  -0.148500, -0.133275, -0.114345, -0.094656, -0.079274, -0.067348, -0.055519, -0.040605, -0.027864, -0.017981, -0.006669, 0.004576, 0.013697, 0.021386, 0.029691, 0.041225, 0.054397, 0.069648, 0.082131, 0.092306, 0.099757
#*# 	  -0.160366, -0.143424, -0.129078, -0.106380, -0.091713, -0.080442, -0.067404, -0.052024, -0.039587, -0.027819, -0.017042, -0.005035, 0.004399, 0.012659, 0.021386, 0.034123, 0.047952, 0.064336, 0.076570, 0.087561, 0.096242
#*# 	  -0.169119, -0.152534, -0.134064, -0.116062, -0.100421, -0.088160, -0.076507, -0.060196, -0.046093, -0.035097, -0.022845, -0.010949, -0.001577, 0.007030, 0.017152, 0.030600, 0.044978, 0.060675, 0.073641, 0.085579, 0.095602
#*# 	  -0.172444, -0.155062, -0.140839, -0.120174, -0.105724, -0.093016, -0.081240, -0.064489, -0.050029, -0.036716, -0.024538, -0.013291, -0.004049, 0.003767, 0.014387, 0.029465, 0.045812, 0.061363, 0.074040, 0.086872, 0.095343
#*# 	  -0.174541, -0.158242, -0.138203, -0.122440, -0.106545, -0.094317, -0.083056, -0.065741, -0.048207, -0.036868, -0.023488, -0.011784, -0.004439, 0.004195, 0.016085, 0.031056, 0.047213, 0.063395, 0.074794, 0.086020, 0.096475
#*# 	  -0.172791, -0.156124, -0.137903, -0.119943, -0.106005, -0.095051, -0.082192, -0.064448, -0.050037, -0.035081, -0.022055, -0.011501, -0.001871, 0.005809, 0.018116, 0.034715, 0.049672, 0.065439, 0.079089, 0.088489, 0.097580
#*# 	  -0.172170, -0.153367, -0.131827, -0.114465, -0.101290, -0.088388, -0.077712, -0.062126, -0.046294, -0.032988, -0.018834, -0.006705, 0.000546, 0.009789, 0.022478, 0.036315, 0.051894, 0.067657, 0.079588, 0.089389, 0.098566
#*# 	  -0.172959, -0.153106, -0.133904, -0.113889, -0.098124, -0.086561, -0.074001, -0.059999, -0.046235, -0.031922, -0.017904, -0.005909, 0.004036, 0.012235, 0.025283, 0.039943, 0.053896, 0.069856, 0.083631, 0.093018, 0.101672
#*# 	  -0.174733, -0.155781, -0.134065, -0.115297, -0.097760, -0.082745, -0.073397, -0.059277, -0.045571, -0.032329, -0.017164, -0.002997, 0.005775, 0.015348, 0.027459, 0.040537, 0.058953, 0.073714, 0.083943, 0.093442, 0.101192
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 35.0
#*# max_x = 200.0
#*# min_y = 35.0
#*# max_y = 220.0
