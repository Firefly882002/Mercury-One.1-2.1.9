[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include EBB.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]
[auto_speed]

[temperature_sensor Pi]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

[idle_timeout]
# only turn off heaters and motors if the printer is not paused
gcode:
    {% if not printer.pause_resume.is_paused %}
        TURN_OFF_HEATERS
        M84
    {% endif %}

[autotune_tmc stepper_x]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_y]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z1]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z2]
motor: omc-17he19-2004s
tuning_goal: auto

[input_shaper]
shaper_freq_x: 57.2   #Max 9700mm
shaper_freq_y: 56.6   #Max 9400mm
shaper_type: mzv


[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_0E001F000C50415833323420-if00
canbus_uuid: df8f643798ab
#restart_method: command

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000
max_z_velocity: 5
max_z_accel: 100

[cartographer]
#   Path to the serial port for the Cartographer device. Typically has the form
#   /dev/serial/by-id/usb-cartographer_cartographer_...
#   
#   If you are using the CAN Bus version, replace serial: with canbus_uuid: and add the UUID.
canbus_uuid: 410c1e562634
#
speed: 40.
#   Z probing dive speed.
lift_speed: 5.
#   Z probing lift speed.
backlash_comp: 0.00945
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
x_offset: 0.
#   X offset of cartographer from the nozzle.
y_offset: 21.1
#   Y offset of cartographer from the nozzle.
trigger_distance: 2.
#   cartographer trigger distance for homing.
trigger_dive_threshold: 1.5
#   Threshold for range vs dive mode probing. Beyond `trigger_distance +
#   trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006
#   Hysteresis on trigger threshold for untriggering, as a percentage of the
#   trigger threshold.
cal_nozzle_z: 0.1
#   Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1
#   Minimum z bound on sensor response measurement.
cal_ceil:5.
#   Maximum z bound on sensor response measurement.
cal_speed: 1.0
#   Speed while measuring response curve.
cal_move_speed: 10.
#   Speed while moving to position for response curve measurement.
default_model_name: default
#   Name of default cartographer model to load.
mesh_main_direction: x
#   Primary travel direction during mesh measurement.
#mesh_overscan: -1
#   Distance to use for direction changes at mesh line ends. Omit this setting
#   and a default will be calculated from line spacing and available travel.
mesh_cluster_size: 1
#   Radius of mesh grid point clusters.
mesh_runs: 2
#   Number of passes to make during mesh scan.

[lis2dw]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
probe_points:
    127.5,122, 20



[stepper_x]
step_pin: PE6
dir_pin: PA14
enable_pin: !PE0
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan: PB6
position_endstop: 255
position_max: 255
homing_speed: 100

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PD3
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG11
driver_SGTHRS: 70

[stepper_y]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG6
position_endstop: 244
position_max: 244
homing_speed: 100

[tmc2209 stepper_y]
uart_pin: PE1
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG12
driver_SGTHRS: 72

[stepper_z]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8  
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 240
position_min: -5
homing_speed: 10 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC4
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Center
[stepper_z1]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PD11
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Front Right
[stepper_z2]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PC6
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[safe_z_home]
speed: 100
z_hop: 10
z_hop_speed: 5
home_xy_position: 127.5,122

[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 32
rotation_distance: 22.452
gear_ratio: 50:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBBCan: PA3
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 250
max_extrude_cross_section: 5
min_extrude_temp: 185
pressure_advance: 0.025

[tmc2209 extruder]
uart_pin: EBBCan: PA15
run_current: 0.650
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF4
#max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid

[bed_mesh]
speed: 300
horizontal_move_z: 10
mesh_min: 35, 35
mesh_max: 200, 220
probe_count: 21,21
algorithm: bicubic


[fan]
pin: EBBCan: PA1

[heater_fan hotend_fan]
pin: EBBCan: PA0
heater: extruder
heater_temp: 50.0

[z_tilt]
z_positions: 8, 8 #stepper_z Mini Tank
  132.5, 247 #stepper_z1 Mini Tank
  257, 8 #stepper_z2 Mini Tank
points: 
  15, 0 #probe location stepper_z (left)
  132.5,210  #probe location stepper_z (rear)
# 15, 210
#  240, 210  
  240, 0 #probe location stepper_z (right)
speed: 400
horizontal_move_z: 10
retries: 5 # Number of times to retry if the probed points aren't within tolerance.
retry_tolerance:0.003







#The following Macro is used to replace the ending gcode in your slicer
#replace the end gcode in your slicer with END_PRINT

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# pid_kp = 42.375
#*# pid_ki = 1.922
#*# pid_kd = 233.590
#*# control = pid
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.396
#*# pid_ki = 2.127
#*# pid_kd = 94.774
#*#
#*# [cartographer model default]
#*# model_coef = 1.3603677619316925,
#*# 	1.7351196226592445,
#*# 	0.7905886475253496,
#*# 	0.32609380640133473,
#*# 	0.22748171677272946,
#*# 	0.5225177996593849,
#*# 	0.12942732810068813,
#*# 	-0.6567748632704603,
#*# 	0.04184012423365669,
#*# 	0.5251931019743251
#*# model_domain = 3.1851211326899135e-07,3.3905519664678e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.195134
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.004995, 0.001736, -0.000716, -0.000585, 0.000653, 0.001675, 0.002829, 0.002574, 0.000762, -0.001701, -0.003216, -0.002067, 0.000623, -0.000391, -0.000349, 0.001097, 0.003059, 0.006647, 0.010941, 0.012171, 0.011085
#*# 	  0.005332, 0.002746, 0.000393, 0.000620, 0.001912, 0.002540, 0.003368, 0.003636, 0.001864, -0.000480, -0.002632, -0.001588, -0.000519, -0.001605, -0.002709, -0.001581, 0.000599, 0.003650, 0.008047, 0.009416, 0.008010
#*# 	  0.003419, 0.001318, -0.001503, -0.000596, 0.001675, 0.001579, 0.003073, 0.003892, 0.001857, -0.001373, -0.002112, -0.001674, -0.002664, -0.004369, -0.005413, -0.004862, -0.002617, 0.000602, 0.004972, 0.006887, 0.005629
#*# 	  0.000493, -0.002169, -0.004827, -0.003642, -0.001719, -0.000449, 0.001716, 0.003170, 0.001717, -0.001412, -0.002523, -0.002636, -0.004832, -0.007193, -0.008393, -0.007608, -0.005976, -0.003042, 0.000718, 0.002750, 0.002325
#*# 	  -0.006762, -0.008175, -0.008732, -0.007320, -0.005960, -0.004448, -0.002259, -0.000490, -0.001562, -0.004111, -0.005941, -0.005966, -0.007465, -0.010361, -0.011969, -0.012114, -0.011267, -0.008265, -0.004601, -0.003297, -0.004046
#*# 	  -0.014892, -0.015747, -0.014793, -0.012898, -0.010815, -0.009284, -0.008093, -0.006527, -0.007893, -0.009829, -0.011478, -0.011476, -0.013139, -0.015029, -0.017005, -0.017070, -0.017540, -0.014568, -0.010314, -0.009329, -0.010408
#*# 	  -0.023629, -0.022958, -0.022892, -0.020229, -0.017267, -0.015043, -0.014568, -0.014385, -0.014888, -0.016983, -0.017070, -0.018097, -0.019766, -0.021433, -0.023260, -0.023122, -0.022539, -0.020216, -0.016217, -0.014295, -0.015853
#*# 	  -0.032134, -0.031374, -0.030838, -0.028289, -0.026021, -0.023720, -0.023540, -0.023429, -0.024168, -0.024851, -0.024759, -0.025211, -0.026792, -0.029196, -0.030695, -0.029724, -0.028280, -0.025787, -0.021253, -0.019310, -0.020328
#*# 	  -0.041627, -0.040379, -0.038384, -0.036945, -0.034545, -0.034286, -0.033414, -0.032551, -0.033218, -0.033660, -0.032643, -0.032703, -0.034890, -0.037853, -0.039213, -0.038075, -0.035470, -0.031075, -0.026971, -0.025338, -0.025932
#*# 	  -0.050313, -0.048474, -0.045439, -0.042624, -0.042365, -0.042569, -0.042567, -0.041463, -0.040892, -0.041497, -0.040378, -0.040389, -0.042314, -0.044778, -0.046833, -0.045759, -0.042229, -0.036994, -0.031951, -0.030327, -0.031602
#*# 	  -0.057133, -0.055886, -0.051715, -0.048761, -0.047091, -0.048059, -0.048221, -0.047158, -0.047203, -0.047059, -0.045912, -0.045931, -0.047081, -0.049654, -0.051566, -0.050569, -0.047372, -0.040958, -0.035474, -0.033656, -0.034763
#*# 	  -0.064867, -0.063379, -0.059571, -0.054649, -0.052842, -0.054442, -0.055704, -0.054675, -0.053850, -0.053325, -0.052176, -0.052145, -0.053936, -0.055624, -0.056173, -0.054989, -0.051269, -0.045095, -0.038981, -0.036869, -0.038119
#*# 	  -0.069769, -0.069474, -0.065019, -0.060086, -0.058259, -0.059840, -0.061607, -0.059558, -0.058389, -0.058372, -0.057509, -0.057603, -0.058922, -0.060110, -0.060614, -0.057860, -0.052788, -0.046260, -0.041185, -0.039170, -0.039000
#*# 	  -0.070188, -0.070465, -0.066558, -0.061812, -0.059492, -0.061635, -0.062967, -0.061645, -0.059548, -0.059549, -0.059598, -0.058358, -0.060055, -0.061423, -0.061108, -0.058343, -0.052732, -0.045825, -0.040450, -0.038096, -0.037618
#*# 	  -0.068890, -0.069252, -0.066419, -0.062093, -0.060456, -0.062662, -0.064512, -0.062320, -0.059787, -0.059774, -0.059402, -0.059031, -0.060749, -0.061787, -0.061543, -0.058478, -0.051980, -0.044445, -0.040057, -0.037010, -0.035937
#*# 	  -0.063906, -0.063852, -0.060744, -0.058327, -0.056925, -0.059282, -0.061284, -0.058526, -0.055913, -0.055264, -0.054985, -0.055098, -0.057479, -0.059516, -0.058032, -0.054283, -0.047783, -0.040800, -0.036007, -0.033213, -0.032820
#*# 	  -0.055517, -0.055015, -0.052164, -0.050423, -0.049619, -0.052700, -0.054939, -0.051609, -0.048666, -0.048246, -0.047792, -0.048229, -0.051602, -0.053828, -0.052151, -0.047321, -0.040214, -0.033945, -0.029683, -0.027446, -0.026301
#*# 	  -0.045476, -0.044354, -0.041702, -0.039256, -0.039828, -0.043354, -0.046089, -0.042736, -0.040393, -0.039278, -0.038974, -0.040362, -0.043259, -0.044846, -0.043750, -0.039071, -0.032785, -0.025845, -0.021754, -0.020476, -0.020565
#*# 	  -0.036153, -0.034163, -0.030322, -0.027892, -0.029201, -0.032008, -0.034776, -0.033667, -0.031985, -0.030833, -0.029713, -0.030324, -0.032832, -0.035385, -0.033772, -0.030313, -0.024758, -0.018378, -0.014750, -0.013719, -0.013629
#*# 	  -0.026648, -0.024821, -0.020434, -0.017900, -0.017380, -0.020444, -0.023726, -0.023645, -0.023004, -0.021586, -0.020776, -0.021272, -0.023634, -0.025449, -0.023653, -0.019838, -0.015783, -0.010409, -0.006681, -0.005949, -0.006113
#*# 	  -0.016396, -0.014882, -0.011454, -0.008310, -0.006826, -0.008170, -0.012854, -0.013671, -0.013678, -0.013695, -0.012176, -0.012515, -0.014512, -0.016184, -0.015563, -0.011463, -0.006467, -0.002063, 0.001511, 0.001077, 0.001787
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 35.0
#*# max_x = 200.0
#*# min_y = 35.0
#*# max_y = 220.0
