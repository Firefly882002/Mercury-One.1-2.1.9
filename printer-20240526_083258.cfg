[include mainsail.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include EBB.cfg]
[include KAMP_Settings.cfg]
[include K-ShakeTune/*.cfg]
[exclude_object]
[auto_speed]

[temperature_sensor Pi]
sensor_type: temperature_host

[temperature_sensor MCU]
sensor_type: temperature_mcu

[idle_timeout]
# only turn off heaters and motors if the printer is not paused
gcode:
    {% if not printer.pause_resume.is_paused %}
        TURN_OFF_HEATERS
        M84
    {% endif %}

[autotune_tmc stepper_x]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_y]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z1]
motor: omc-17he19-2004s
tuning_goal: auto
[autotune_tmc stepper_z2]
motor: omc-17he19-2004s
tuning_goal: auto

[input_shaper]
shaper_freq_x: 57.2   #Max 9700mm
shaper_freq_y: 56.6   #Max 9400mm
shaper_type: mzv


[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_0E001F000C50415833323420-if00
canbus_uuid: df8f643798ab
#restart_method: command

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 10000
max_z_velocity: 5
max_z_accel: 100
square_corner_velocity: 10.0

[cartographer]
#   Path to the serial port for the Cartographer device. Typically has the form
#   /dev/serial/by-id/usb-cartographer_cartographer_...
#   
#   If you are using the CAN Bus version, replace serial: with canbus_uuid: and add the UUID.
canbus_uuid: 410c1e562634
#
speed: 40.
#   Z probing dive speed.
lift_speed: 5.
#   Z probing lift speed.
backlash_comp: 0.00945
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
x_offset: 0.
#   X offset of cartographer from the nozzle.
y_offset: 21.1
#   Y offset of cartographer from the nozzle.
trigger_distance: 2.
#   cartographer trigger distance for homing.
trigger_dive_threshold: 1.5
#   Threshold for range vs dive mode probing. Beyond `trigger_distance +
#   trigger_dive_threshold` a dive will be used.
trigger_hysteresis: 0.006
#   Hysteresis on trigger threshold for untriggering, as a percentage of the
#   trigger threshold.
cal_nozzle_z: 0.1
#   Expected nozzle offset after completing manual Z offset calibration.
cal_floor: 0.1
#   Minimum z bound on sensor response measurement.
cal_ceil:5.
#   Maximum z bound on sensor response measurement.
cal_speed: 1.0
#   Speed while measuring response curve.
cal_move_speed: 10.
#   Speed while moving to position for response curve measurement.
default_model_name: default
#   Name of default cartographer model to load.
mesh_main_direction: x
#   Primary travel direction during mesh measurement.
#mesh_overscan: -1
#   Distance to use for direction changes at mesh line ends. Omit this setting
#   and a default will be calculated from line spacing and available travel.
mesh_cluster_size: 1
#   Radius of mesh grid point clusters.
mesh_runs: 2
#   Number of passes to make during mesh scan.

[lis2dw]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: lis2dw
probe_points:
    127.5,122, 20



[stepper_x]
step_pin: PE6
dir_pin: PA14
enable_pin: !PE0
microsteps: 16
rotation_distance: 40
endstop_pin: EBBCan: PB6
position_endstop: 255
position_max: 255
homing_speed: 100

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_x]
uart_pin: PD3
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG11
driver_SGTHRS: 70

[stepper_y]
step_pin: PE2
dir_pin: !PE3
enable_pin: !PD4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PG6
position_endstop: 244
position_max: 244
homing_speed: 100

[tmc2209 stepper_y]
uart_pin: PE1
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0
diag_pin: ^PG12
driver_SGTHRS: 72

[stepper_z]
step_pin: !PF13
dir_pin: !PF12
enable_pin: !PF14
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8  
microsteps: 32
endstop_pin: probe:z_virtual_endstop # use cartographer as virtual endstop
homing_retract_dist: 0 # cartographer needs this to be set to 0
position_max: 240
position_min: -5
homing_speed: 10 # Leadscrews are slower than 2.4, 10 is a recommended max.
second_homing_speed: 3
homing_retract_dist: 3

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z]
uart_pin: PC4
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z1 Stepper - Rear Center
[stepper_z1]
step_pin: PG0
dir_pin: !PG1
enable_pin: !PF15
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z1]
uart_pin: PD11
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

##  Z2 Stepper - Front Right
[stepper_z2]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8
microsteps: 32

##  Make sure to update below for your relevant driver (2208 or 2209)
[tmc2209 stepper_z2]
uart_pin: PC6
interpolate: true
run_current: 0.8
sense_resistor: 0.110
stealthchop_threshold: 0

[safe_z_home]
speed: 100
z_hop: 10
z_hop_speed: 5
home_xy_position: 127.5,122

[extruder]
step_pin: EBBCan: PD0
dir_pin: !EBBCan: PD1
enable_pin: !EBBCan: PD2
microsteps: 32
rotation_distance: 22.452
gear_ratio: 50:10
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan: PB13
sensor_type: EPCOS 100K B57560G104F
sensor_pin: EBBCan: PA3
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 250
max_extrude_cross_section: 5
min_extrude_temp: 185
pressure_advance: 0.025

[tmc2209 extruder]
uart_pin: EBBCan: PA15
run_current: 0.650
stealthchop_threshold: 999999

[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF4
#max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid

[bed_mesh]
speed: 400
horizontal_move_z: 10
mesh_min: 35, 35
mesh_max: 200, 220
probe_count: 21,21
algorithm: bicubic


[fan]
pin: EBBCan: PA1

[heater_fan hotend_fan]
pin: EBBCan: PA0
heater: extruder
heater_temp: 50.0

[z_tilt]
z_positions: 8, 8 #stepper_z Mini Tank
  132.5, 247 #stepper_z1 Mini Tank
  257, 8 #stepper_z2 Mini Tank
points: 
  15, 0 #probe location stepper_z (left)
  132.5,210  #probe location stepper_z (rear)
# 15, 210
#  240, 210  
  240, 0 #probe location stepper_z (right)
speed: 400
horizontal_move_z: 10
retries: 5 # Number of times to retry if the probed points aren't within tolerance.
retry_tolerance:0.003


##  Controller fan - FAN
[controller_fan controller_fan_1]
pin: PA8
kick_start_time: 0.5
heater: heater_bed
stepper: stepper_x,stepper_y,stepper_z,stepper_z1,stepper_z2




#The following Macro is used to replace the ending gcode in your slicer
#replace the end gcode in your slicer with END_PRINT

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# pid_kp = 42.375
#*# pid_ki = 1.922
#*# pid_kd = 233.590
#*# control = pid
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.396
#*# pid_ki = 2.127
#*# pid_kd = 94.774
#*#
#*# [cartographer model default]
#*# model_coef = 1.3603677619316925,
#*# 	  1.7351196226592445,
#*# 	  0.7905886475253496,
#*# 	  0.32609380640133473,
#*# 	  0.22748171677272946,
#*# 	  0.5225177996593849,
#*# 	  0.12942732810068813,
#*# 	  -0.6567748632704603,
#*# 	  0.04184012423365669,
#*# 	  0.5251931019743251
#*# model_domain = 3.1851211326899135e-07,3.3905519664678e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 25.195134
#*# model_offset = 0.01000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.013739, 0.016486, 0.018624, 0.023803, 0.029794, 0.033606, 0.037510, 0.039833, 0.040913, 0.040642, 0.039690, 0.040784, 0.043218, 0.042817, 0.040913, 0.040219, 0.039011, 0.039869, 0.041937, 0.040476, 0.036721
#*# 	  0.015918, 0.018291, 0.020902, 0.025623, 0.031745, 0.036500, 0.039903, 0.043322, 0.043841, 0.042957, 0.042334, 0.042937, 0.044434, 0.042873, 0.040912, 0.040425, 0.039019, 0.039054, 0.041826, 0.040735, 0.036127
#*# 	  0.015074, 0.017903, 0.019936, 0.025132, 0.031356, 0.036716, 0.040766, 0.043974, 0.045494, 0.044188, 0.043977, 0.044750, 0.044861, 0.042364, 0.039693, 0.039005, 0.037547, 0.037549, 0.039830, 0.039691, 0.034704
#*# 	  0.012825, 0.014357, 0.018264, 0.024599, 0.030489, 0.035347, 0.040808, 0.044500, 0.046321, 0.045258, 0.044683, 0.045339, 0.043968, 0.041738, 0.038763, 0.037272, 0.035661, 0.035378, 0.036597, 0.036368, 0.032194
#*# 	  0.005216, 0.009307, 0.013877, 0.020491, 0.026426, 0.031758, 0.036224, 0.040210, 0.042882, 0.042884, 0.041830, 0.042218, 0.040913, 0.038624, 0.035320, 0.033423, 0.031055, 0.031145, 0.032300, 0.030145, 0.026676
#*# 	  -0.002099, 0.000620, 0.007809, 0.015438, 0.021243, 0.027620, 0.031577, 0.033370, 0.037544, 0.037300, 0.036729, 0.036435, 0.035456, 0.034087, 0.031073, 0.028128, 0.025973, 0.025535, 0.027583, 0.025199, 0.021087
#*# 	  -0.011630, -0.005763, 0.000099, 0.006816, 0.014174, 0.020460, 0.023718, 0.026707, 0.027997, 0.028987, 0.030473, 0.030018, 0.028399, 0.027075, 0.023494, 0.022545, 0.020821, 0.020450, 0.021340, 0.021330, 0.016219
#*# 	  -0.020879, -0.014915, -0.008724, -0.001367, 0.005187, 0.010447, 0.014404, 0.016525, 0.020295, 0.020325, 0.022436, 0.022682, 0.021450, 0.019164, 0.016010, 0.014981, 0.014820, 0.014346, 0.016993, 0.014795, 0.011618
#*# 	  -0.029751, -0.025520, -0.016777, -0.009004, -0.004858, 0.001696, 0.005017, 0.006349, 0.009922, 0.012834, 0.013628, 0.014282, 0.012643, 0.009159, 0.007250, 0.006971, 0.006596, 0.007186, 0.010282, 0.008962, 0.006501
#*# 	  -0.040373, -0.033500, -0.025629, -0.017812, -0.012486, -0.007070, -0.005422, -0.001417, 0.001575, 0.003178, 0.005360, 0.005714, 0.004734, 0.002810, -0.000141, -0.003034, -0.001483, 0.001713, 0.003359, 0.002560, -0.002738
#*# 	  -0.050810, -0.044230, -0.035209, -0.025664, -0.019852, -0.016172, -0.013995, -0.011446, -0.007651, -0.005399, -0.002566, -0.002196, -0.004059, -0.005399, -0.008039, -0.008724, -0.009207, -0.005992, -0.002693, -0.004599, -0.007071
#*# 	  -0.058790, -0.052848, -0.044155, -0.033622, -0.027192, -0.024278, -0.023726, -0.019034, -0.014799, -0.012596, -0.011193, -0.010462, -0.012164, -0.012582, -0.014798, -0.015059, -0.013753, -0.009278, -0.007517, -0.008361, -0.011848
#*# 	  -0.066194, -0.059922, -0.051366, -0.041599, -0.034562, -0.032003, -0.031053, -0.027094, -0.022802, -0.020411, -0.018953, -0.017364, -0.018085, -0.019664, -0.021966, -0.020531, -0.018002, -0.013780, -0.013061, -0.012447, -0.015885
#*# 	  -0.070422, -0.065899, -0.056766, -0.047767, -0.041768, -0.038533, -0.037012, -0.033894, -0.028361, -0.026361, -0.025044, -0.023104, -0.024754, -0.026145, -0.025872, -0.026492, -0.023907, -0.018438, -0.014509, -0.016098, -0.018983
#*# 	  -0.071950, -0.068589, -0.057825, -0.050114, -0.045300, -0.041816, -0.041423, -0.037231, -0.031355, -0.029681, -0.029164, -0.026041, -0.026717, -0.029630, -0.030609, -0.028695, -0.023720, -0.020344, -0.017902, -0.017533, -0.019522
#*# 	  -0.070306, -0.062967, -0.056165, -0.048897, -0.043243, -0.041445, -0.040361, -0.034996, -0.030323, -0.027830, -0.025618, -0.025393, -0.028605, -0.029744, -0.030314, -0.027954, -0.023008, -0.019320, -0.017232, -0.017002, -0.019383
#*# 	  -0.066272, -0.060713, -0.050504, -0.043350, -0.041485, -0.039784, -0.037991, -0.033457, -0.027590, -0.024657, -0.024479, -0.023140, -0.025714, -0.028014, -0.028701, -0.025915, -0.020896, -0.017699, -0.015045, -0.015783, -0.019087
#*# 	  -0.059477, -0.052066, -0.047059, -0.038347, -0.034208, -0.035400, -0.033488, -0.029598, -0.025447, -0.020866, -0.019547, -0.019198, -0.022771, -0.025079, -0.024512, -0.021198, -0.017613, -0.016560, -0.012368, -0.012927, -0.018002
#*# x_count = 21
#*# y_count = 18
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 35.0
#*# max_x = 199.059
#*# min_y = 38.8661
#*# max_y = 194.877
#*#
#*# [bed_mesh p1]
#*# version = 1
#*# points =
#*# 	  0.013739, 0.016486, 0.018624, 0.023803, 0.029794, 0.033606, 0.037510, 0.039833, 0.040913, 0.040642, 0.039690, 0.040784, 0.043218, 0.042817, 0.040913, 0.040219, 0.039011, 0.039869, 0.041937, 0.040476, 0.036721
#*# 	  0.015918, 0.018291, 0.020902, 0.025623, 0.031745, 0.036500, 0.039903, 0.043322, 0.043841, 0.042957, 0.042334, 0.042937, 0.044434, 0.042873, 0.040912, 0.040425, 0.039019, 0.039054, 0.041826, 0.040735, 0.036127
#*# 	  0.015074, 0.017903, 0.019936, 0.025132, 0.031356, 0.036716, 0.040766, 0.043974, 0.045494, 0.044188, 0.043977, 0.044750, 0.044861, 0.042364, 0.039693, 0.039005, 0.037547, 0.037549, 0.039830, 0.039691, 0.034704
#*# 	  0.012825, 0.014357, 0.018264, 0.024599, 0.030489, 0.035347, 0.040808, 0.044500, 0.046321, 0.045258, 0.044683, 0.045339, 0.043968, 0.041738, 0.038763, 0.037272, 0.035661, 0.035378, 0.036597, 0.036368, 0.032194
#*# 	  0.005216, 0.009307, 0.013877, 0.020491, 0.026426, 0.031758, 0.036224, 0.040210, 0.042882, 0.042884, 0.041830, 0.042218, 0.040913, 0.038624, 0.035320, 0.033423, 0.031055, 0.031145, 0.032300, 0.030145, 0.026676
#*# 	  -0.002099, 0.000620, 0.007809, 0.015438, 0.021243, 0.027620, 0.031577, 0.033370, 0.037544, 0.037300, 0.036729, 0.036435, 0.035456, 0.034087, 0.031073, 0.028128, 0.025973, 0.025535, 0.027583, 0.025199, 0.021087
#*# 	  -0.011630, -0.005763, 0.000099, 0.006816, 0.014174, 0.020460, 0.023718, 0.026707, 0.027997, 0.028987, 0.030473, 0.030018, 0.028399, 0.027075, 0.023494, 0.022545, 0.020821, 0.020450, 0.021340, 0.021330, 0.016219
#*# 	  -0.020879, -0.014915, -0.008724, -0.001367, 0.005187, 0.010447, 0.014404, 0.016525, 0.020295, 0.020325, 0.022436, 0.022682, 0.021450, 0.019164, 0.016010, 0.014981, 0.014820, 0.014346, 0.016993, 0.014795, 0.011618
#*# 	  -0.029751, -0.025520, -0.016777, -0.009004, -0.004858, 0.001696, 0.005017, 0.006349, 0.009922, 0.012834, 0.013628, 0.014282, 0.012643, 0.009159, 0.007250, 0.006971, 0.006596, 0.007186, 0.010282, 0.008962, 0.006501
#*# 	  -0.040373, -0.033500, -0.025629, -0.017812, -0.012486, -0.007070, -0.005422, -0.001417, 0.001575, 0.003178, 0.005360, 0.005714, 0.004734, 0.002810, -0.000141, -0.003034, -0.001483, 0.001713, 0.003359, 0.002560, -0.002738
#*# 	  -0.050810, -0.044230, -0.035209, -0.025664, -0.019852, -0.016172, -0.013995, -0.011446, -0.007651, -0.005399, -0.002566, -0.002196, -0.004059, -0.005399, -0.008039, -0.008724, -0.009207, -0.005992, -0.002693, -0.004599, -0.007071
#*# 	  -0.058790, -0.052848, -0.044155, -0.033622, -0.027192, -0.024278, -0.023726, -0.019034, -0.014799, -0.012596, -0.011193, -0.010462, -0.012164, -0.012582, -0.014798, -0.015059, -0.013753, -0.009278, -0.007517, -0.008361, -0.011848
#*# 	  -0.066194, -0.059922, -0.051366, -0.041599, -0.034562, -0.032003, -0.031053, -0.027094, -0.022802, -0.020411, -0.018953, -0.017364, -0.018085, -0.019664, -0.021966, -0.020531, -0.018002, -0.013780, -0.013061, -0.012447, -0.015885
#*# 	  -0.070422, -0.065899, -0.056766, -0.047767, -0.041768, -0.038533, -0.037012, -0.033894, -0.028361, -0.026361, -0.025044, -0.023104, -0.024754, -0.026145, -0.025872, -0.026492, -0.023907, -0.018438, -0.014509, -0.016098, -0.018983
#*# 	  -0.071950, -0.068589, -0.057825, -0.050114, -0.045300, -0.041816, -0.041423, -0.037231, -0.031355, -0.029681, -0.029164, -0.026041, -0.026717, -0.029630, -0.030609, -0.028695, -0.023720, -0.020344, -0.017902, -0.017533, -0.019522
#*# 	  -0.070306, -0.062967, -0.056165, -0.048897, -0.043243, -0.041445, -0.040361, -0.034996, -0.030323, -0.027830, -0.025618, -0.025393, -0.028605, -0.029744, -0.030314, -0.027954, -0.023008, -0.019320, -0.017232, -0.017002, -0.019383
#*# 	  -0.066272, -0.060713, -0.050504, -0.043350, -0.041485, -0.039784, -0.037991, -0.033457, -0.027590, -0.024657, -0.024479, -0.023140, -0.025714, -0.028014, -0.028701, -0.025915, -0.020896, -0.017699, -0.015045, -0.015783, -0.019087
#*# 	  -0.059477, -0.052066, -0.047059, -0.038347, -0.034208, -0.035400, -0.033488, -0.029598, -0.025447, -0.020866, -0.019547, -0.019198, -0.022771, -0.025079, -0.024512, -0.021198, -0.017613, -0.016560, -0.012368, -0.012927, -0.018002
#*# x_count = 21
#*# y_count = 18
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 35.0
#*# max_x = 199.059
#*# min_y = 38.8661
#*# max_y = 194.877
